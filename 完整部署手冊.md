# RayBot 完整架設指南 (Cloudflare Worker + D1 + LINE Bot)

本手冊將引導您從零開始，使用 Cloudflare Worker 架設一個包含前後端、資料庫與 AI 功能的 LINE 作業管理機器人。

---

## 📌 前置準備
在開始之前，請確保您擁有：
1.  **LINE 帳號**：用於申請 Messaging API。
2.  **Cloudflare 帳號**：用於部署 Worker 與資料庫。
3.  **GitHub 帳號** (選用)：用於版本控制 (非必須)。
4.  **Node.js 環境** (建議)：雖然可用網頁版部署，但使用指令列 (CLI) 管理 `wrangler` 會更方便。

---

## 🚀 第一步：LINE Developers 設定
1.  前往 [LINE Developers Console](https://developers.line.biz/) 並登入。
2.  建立一個 **Provider** (名稱自訂)。
3.  建立一個 **Messaging API** Channel。
    *   **Channel access token**: 進入 **Messaging API** 分頁，滑到最下方點擊 Issue (產生長效 Token)，**複製並保存**。
    *   **Channel Secret**: 進入 **Basic settings** 分頁，找到 Channel Secret，**複製並保存**。
4.  **設定回應模式**：
    *   Auto-reply messages: **Disabled** (關閉)
    *   Greeting messages: **Disabled** (關閉)
    *   Webhooks: **Enabled** (開啟)
    *   *Webhook URL 稍後填寫*。

---

## 🚀 第二步：Cloudflare 環境建置

### 1. 登入 Cloudflare Workers
前往 [Cloudflare Dashboard](https://dash.cloudflare.com/) -> **Workers & Pages** -> **Create Application** -> **Create Worker**。
*   命名您的 Worker (例如 `homework-bot`)。
*   點擊 **Deploy** (先部署一個空殼)。

### 2. 建立 D1 資料庫
1.  在 Cloudflare 側邊欄選擇 **D1 SQL Database**。
2.  點擊 **Create**，命名為 `homework-db`。
3.  進入資料庫，選擇 **Console** 標籤。
4.  **貼上以下 SQL 指令並執行 (Execute)**，以建立資料表：

```sql
CREATE TABLE IF NOT EXISTS group_auth (group_id TEXT PRIMARY KEY, 群組名稱 TEXT, 角色設定 TEXT, 科目設定 TEXT, advanced_settings TEXT, status TEXT DEFAULT 'active', version TEXT, is_locked INTEGER DEFAULT 0, locking_user_id TEXT, last_warning_ts INTEGER, terminated_at TEXT, last_data_update INTEGER);
CREATE TABLE IF NOT EXISTS tasks (id INTEGER PRIMARY KEY AUTOINCREMENT, 群組 TEXT, 建立時間 INTEGER, 截止日期 TEXT, due_time TEXT, 科目 TEXT, 內容 TEXT, 狀態 TEXT, 類別 TEXT, 來源 TEXT, is_hidden INTEGER DEFAULT 0, display_start_time TEXT, is_reliable INTEGER DEFAULT 1);
CREATE TABLE IF NOT EXISTS line_user_state (user_id TEXT PRIMARY KEY, group_id TEXT, state TEXT, updated_at INTEGER);
CREATE TABLE IF NOT EXISTS group_agreements (group_id TEXT, user_id TEXT, agreed_at INTEGER, PRIMARY KEY (group_id, user_id));
CREATE TABLE IF NOT EXISTS task_suggestions (id INTEGER PRIMARY KEY AUTOINCREMENT, task_id INTEGER, group_id TEXT, suggested_by TEXT, suggestion_content TEXT, suggestion_subject TEXT, suggestion_category TEXT, status TEXT DEFAULT 'pending', created_at INTEGER);
CREATE TABLE IF NOT EXISTS system_settings (key TEXT PRIMARY KEY, value TEXT, updated_at INTEGER);
CREATE TABLE IF NOT EXISTS logs (id INTEGER PRIMARY KEY AUTOINCREMENT, group_id TEXT, actor TEXT, action TEXT, details TEXT, ip_address TEXT, user_agent TEXT, timestamp INTEGER);
```

### 3. 綁定變數與資料庫
回到您的 Worker 頁面 -> **Settings** -> **Variables**：

**A. 環境變數 (Environment Variables) - 加密變數請點 "Encrypt"**
| Variable name | Value | 說明 |
| :--- | :--- | :--- |
| `SUPER_ADMIN_PASSWORD` | (自訂密碼) | Super Admin 後台登入密碼 (務必複雜) |
| `LINE_CHANNEL_ACCESS_TOKEN`| (貼上 Token) | LINE 長效存取權杖 |
| `LINE_CHANNEL_SECRET` | (貼上 Secret) | LINE Channel Secret |

**B. 綁定 (Bindings)**
1.  找到 **D1 Database Bindings** -> Add Binding
    *   Variable name: `DB` (必須是大寫 DB)
    *   Database: 選擇剛剛建立的 `homework-db`
2.  找到 **Workers AI Bindings** -> Add Binding
    *   Variable name: `AI` (必須是大寫 AI)

---

## 🚀 第三步：部署程式碼

1.  點擊 Worker 頁面右上角的 **Edit code**。
2.  將 `worker.js` (也就是包含 Part 1 ~ Part 10 的完整程式碼) 全部複製貼上，覆蓋原有的內容。
3.  點擊右上角 **Deploy**。
4.  部署成功後，你會獲得一個網址，例如：`https://homework-bot.xxx.workers.dev`。

---

## 🚀 第四步：完成 LINE Webhook 設定

1.  回到 [LINE Developers Console](https://developers.line.biz/)。
2.  在 **Messaging API** -> **Webhook URL** 欄位。
3.  填入 Cloudflare Worker 的網址 (必須是 `https://` 開頭)。
4.  點擊 **Update** 並點擊 **Verify**。
5.  如果顯示 **Success**，恭喜！架設完成。

---

## 🎮 開始使用

1.  **加入好友**：用手機掃描 LINE Bot 的 QR Code。
2.  **建立群組**：將機器人邀請進入一個群組。
3.  **初始化**：
    *   在群組輸入 `/bot start`。
    *   點擊連結閱讀條款，輸入 `/bot agree` 同意。
    *   輸入 `/bot newID` 建立新班級 ID。
4.  **後台管理**：
    *   輸入 `/bot manager` 取得後台連結。
    *   預設帳號：`Administrator`
    *   預設密碼：(空) / 或使用 `/bot 復原碼` 查詢。
    *   **強烈建議**：立刻去後台設定密碼，並進行 LINE 綁定。
5.  **超級後台**：
    *   網址：`https://你的Worker網址/super-admin`
    *   密碼：設定於環境變數 `SUPER_ADMIN_PASSWORD` 的值。

---

## ❓ 常見問題 (Troubleshooting)

*   **Q: 機器人已讀不回？**
    *   A: 檢查 LINE 後台 Webhook 是否開啟 (Enabled)。
    *   A: 檢查是否已 `/bot agree` 解鎖群組。
    *   A: 檢查 Cloudflare Logs 是否有錯誤訊息。

*   **Q: 資料庫寫入失敗 (no column named ...)?**
    *   A: 這通常是表結構版本不符。程式碼有自動修復機制，請嘗試重新整理網頁或重新發送指令觸發。
    *   A: 若仍無效，請到 D1 Console 手動執行 `ALTER TABLE` 指令補欄位。

*   **Q: 後台登入一直說密碼錯誤？**
    *   A: 請確認是否輸入了空白鍵。
    *   A: 若真的忘記，請使用 Super Admin 後台的「重置救援碼」功能，再用救援碼重置密碼。
